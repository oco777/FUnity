# Scratch モード

Scratch モードは「Scratch 3.0 と同等の制作体験」を目標としたプリセットです。ステージ解像度、座標系、標準ブロックの挙動を FUnity 上で再現し、既存の Scratch プロジェクトからの移行を支援します。

## ステージ仕様
- **ピクセルサイズ**: 480 x 360
- **論理座標**: 中心原点で X ∈ [-240, +240], Y ∈ [-180, +180]
- **Pixels Per Unit**: 100 (1 ユニット = 100 ピクセル)
- **カメラ推奨**: Orthographic / Size = 180 (縦半径) で中央原点に合わせる
- **UI Toolkit**: PanelSettings を `Fit (Contain)`、参照 DPI を 96 とし、背景のレターボックスを抑えます

### 表示スケール（Scratch 専用）
- 論理ステージは常に **480 x 360** として扱い、ゲーム内の座標・当たり判定は固定サイズを基準に維持します。
- 実ウィンドウが 480 x 360 より大きい場合は `scale = min(width / 480, height / 360)`（ただし `scale >= 1`）で UI ルートを等倍以上に拡大します。
- 480 x 360 未満のウィンドウでは縮小せず、論理ステージをそのまま表示します（1.0 倍表示）。

## 座標系（重要）
- 原点は **ステージ中央(0,0)**。右が +X、上が +Y です。論理サイズは常に **480×360**（±240 / ±180）で計算します。
- UI Toolkit の左上原点座標とはランタイムで自動変換されます。Scratch モードでは次の式が適用されます。
  - `uiX = logicalX + 240`
  - `uiY = 180 - logicalY`
  - `logicalX = uiX - 240`
  - `logicalY = 180 - uiY`
- unityroom など左上原点モードでは UI Toolkit 座標をそのまま論理座標として扱います。
- 背景画像は `StageBackgroundService` により常に中央配置され、拡大縮小は行いません（`contain/cover` の指定のみ適用）。
- `FUnityActorData.Anchor` で **Center (既定)** / **TopLeft** を切り替えられます。Center を選ぶと座標が画像中心に一致し、TopLeft は UI Toolkit と同じ左上基準になります。

## ブロック互換ポリシー
- Scratch 標準カテゴリ（動き/見た目/音/イベント/制御/調べる/演算/変数/リスト）を Visual Scripting で完全再現することを目標にしています。
- ブロックごとのマッピングは [`BlocksMapping.md`](BlocksMapping.md) を参照してください。
- 実装が未完了のブロックはエディタ上で警告を表示し、可能な範囲で近似動作を提供します。未対応一覧は本ドキュメント末尾に記録します。

## SB3 インポート
実験的な `.sb3` インポート機能を提供します。手順は以下の通りです。

1. `FUnity / Authoring / Switch Mode…` で Scratch モードをアクティブ化します。
2. `Assets` 配下に `.sb3` ファイルをドラッグ＆ドロップします。
3. インポーターが `project.json` を解析し、`FUnityProjectData` / `FUnityActorData` に変換します。
4. `assets/` 内の画像は Sprite 化され、音声は `AudioClip` として保存されます。
5. 未対応ブロックが含まれる場合は、インポートレポートに警告が出力されます。

詳細なマッピング仕様は [`SB3_Importer.md`](SB3_Importer.md) にまとめています。

## 既知の制約
- ペン拡張、ビデオモーションセンサーなどハードウェア依存拡張は未対応です。
- ステージ背景の一部エフェクト（ゴースト/モザイク）は近似アルゴリズムを使用します。
- サウンドのテンポ変更は Unity の `AudioMixer` 機能に置き換え、完全互換ではありません。

これらの制約は順次アップデートされる予定です。進捗はリリースノートとドキュメントで共有します。
